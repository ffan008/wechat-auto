# 部署检查清单

## ✅ 部署前准备

### 环境检查
- [ ] Python 3.10+ 已安装
- [ ] PostgreSQL 15+ 已安装（或使用Docker）
- [ ] Redis 7+ 已安装（或使用Docker）
- [ ] Git 已安装
- [ ] 服务器有足够的磁盘空间（>10GB）

### 账号和密钥
- [ ] Claude API密钥（https://console.anthropic.com）
  - [ ] 账户有足够余额
  - [ ] API密钥权限已开启
- [ ] 微信公众号
  - [ ] 已认证的服务号或订阅号
  - [ ] 已获取 AppID
  - [ ] 已获取 AppSecret
- [ ] 服务器访问
  - [ ] 有公网IP，或
  - [ ] 配置内网穿透（ngrok/frp）

### 网络配置
- [ ] 服务器防火墙开放端口：80, 443, 8000
- [ ] 域名已解析到服务器IP（可选）
- [ ] SSL证书已准备（可选，Let's Encrypt）

## 🔧 系统配置

### 1. 安装系统
- [ ] 克隆代码仓库
- [ ] 运行安装脚本 `./install.sh`
- [ ] 虚拟环境创建成功
- [ ] 依赖包安装成功

### 2. 环境变量配置
- [ ] 复制 `.env.example` 到 `.env`
- [ ] 填写 ANTHROPIC_API_KEY
- [ ] 填写 WECHAT_APP_ID
- [ ] 填写 WECHAT_APP_SECRET
- [ ] 填写 WECHAT_TOKEN（自定义）
- [ ] 填写 WECHAT_ENCODING_AES_KEY
- [ ] 填写 DATABASE_URL
- [ ] 填写 REDIS_URL
- [ ] 填写 SECRET_KEY（随机生成）

### 3. 数据库初始化
- [ ] PostgreSQL 启动成功
- [ ] Redis 启动成功
- [ ] 数据库表创建成功
- [ ] 数据库连接测试通过

### 4. 服务启动
- [ ] API服务启动成功（`python run.py` 或 `docker-compose up`）
- [ ] Celery Worker 启动成功
- [ ] Celery Beat 启动成功
- [ ] Flower 监控启动成功

## 🔗 微信配置

### 1. 服务器URL配置
- [ ] 确定服务器URL
  - 生产环境：`https://your-domain.com/api/wechat/webhook`
  - 测试环境：`https://abc123.ngrok.io/api/wechat/webhook`
- [ ] URL可访问（使用curl测试）
- [ ] 返回正确的响应

### 2. 微信后台配置
- [ ] 登录微信公众平台
- [ ] 进入"开发 → 基本配置"
- [ ] 填写URL：`https://your-domain.com/api/wechat/webhook`
- [ ] 填写Token（与.env一致）
- [ ] 填写EncodingAESKey（与.env一致）
- [ ] 选择"明文模式"或"安全模式"
- [ ] 点击"提交"验证成功
- [ ] 启用"服务器配置"

### 3. 权限配置
- [ ] 网页授权域名已设置
- [ ] 业务域名已设置
- [ ] 接口权限已开启
  - [ ] 消息管理权限
  - [ ] 用户管理权限
  - [ ] 数据分析权限
  - [ ] 素材管理权限

## 🧪 功能测试

### 1. 基础功能测试
- [ ] 健康检查：`curl http://localhost:8000/health`
- [ ] 微信API测试：`curl http://localhost:8000/api/wechat/test`
- [ ] 数据库连接测试
- [ ] Redis连接测试

### 2. 对话功能测试
- [ ] 关注公众号，收到欢迎消息
- [ ] 发送"你好"，收到自动回复
- [ ] 发送咨询问题，收到准确回复
- [ ] 多轮对话上下文保持

### 3. 内容生成测试
- [ ] 发送"帮我写文章"，能生成内容
- [ ] 生成的大纲合理
- [ ] 生成的正文完整
- [ ] 提供多个标题选项
- [ ] 内容保存为草稿

### 4. 数据分析测试
- [ ] 发送"查看数据"，返回分析报告
- [ ] 数据采集任务正常执行
- [ ] 报告生成任务正常执行

### 5. 定时发布测试
- [ ] 调度内容发布成功
- [ ] 定时任务按时执行
- [ ] 内容发布到微信成功

## 🔍 监控和日志

### 1. 日志配置
- [ ] 日志目录存在（logs/）
- [ ] 日志文件正常生成
- [ ] 日志级别配置正确（INFO/DEBUG）
- [ ] 日志轮转配置

### 2. 监控配置
- [ ] Flower监控可访问（http://localhost:5555）
- [ ] Celery任务状态正常
- [ ] Worker进程运行正常
- [ ] Beat调度器运行正常

### 3. 性能监控
- [ ] API响应时间 <500ms
- [ ] 内存使用正常
- [ ] CPU使用正常
- [ ] 数据库连接池正常

## 🔒 安全检查

### 1. 敏感信息保护
- [ ] .env文件不提交到Git
- [ ] .gitignore配置正确
- [ ] 日志中不包含敏感信息
- [ ] 数据库密码强度足够

### 2. 网络安全
- [ ] 使用HTTPS（生产环境）
- [ ] SSL证书有效
- [ ] 防火墙配置正确
- [ ] 只开放必要端口

### 3. API安全
- [ ] 所有API需要认证（管理端）
- [ ] 速率限制配置
- [ ] SQL注入防护
- [ ] XSS防护

### 4. 微信安全
- [ ] 微信签名验证启用
- [ ] EncodingAESKey安全存储
- [ ] IP白名单配置

## 📊 业务配置

### 1. FAQ知识库
- [ ] 添加常见问题
- [ ] 分类合理
- [ ] 答案准确
- [ ] 关键词完整

### 2. 内容配置
- [ ] AI提示词优化
- [ ] 内容类型配置
- [ ] 目标受众定义
- [ ] 字数限制设置

### 3. 调度配置
- [ ] 发布时间设置
- [ ] 内容日历配置
- [ ] 定时任务启用

## 🚀 上线准备

### 1. 数据备份
- [ ] 数据库自动备份配置
- [ ] 备份存储位置配置
- [ ] 备份恢复测试

### 2. 监控告警
- [ ] 错误日志监控
- [ ] 服务可用性监控
- [ ] 资源使用监控
- [ ] 告警通知配置

### 3. 文档准备
- [ ] 运维手册
- [ ] 故障处理流程
- [ ] 应急预案
- [ ] 联系方式

### 4. 最终测试
- [ ] 完整流程测试
- [ ] 压力测试
- [ ] 故障恢复测试
- [ ] 数据一致性测试

## 📝 上线后检查

### 1. 首日监控
- [ ] 服务稳定性
- [ ] 错误日志
- [ ] 用户反馈
- [ ] 性能指标

### 2. 数据验证
- [ ] 用户数据正确
- [ ] 对话历史完整
- [ ] 内容发布成功
- [ ] 数据统计准确

### 3. 持续优化
- [ ] 根据用户反馈优化回复
- [ ] 调整内容生成策略
- [ ] 优化数据分析维度
- [ ] 改进定时任务时间

---

## 🆘 常见问题处理

### 服务无法启动
1. 检查端口占用
2. 检查环境变量
3. 查看日志文件
4. 检查依赖安装

### 微信消息无响应
1. 检查服务器URL可访问性
2. 检查Token配置
3. 查看API日志
4. 测试工作流

### Claude调用失败
1. 检查API密钥
2. 检查账户余额
3. 检查网络连接
4. 查看错误信息

### 数据库连接失败
1. 检查数据库服务状态
2. 检查连接字符串
3. 检查用户权限
4. 查看数据库日志

---

**祝部署顺利！** 🎉
